--Nome dos médicos que prescreveram mais de um medicamento (Group By e Having)
SELECT M.NOME
FROM MEDICO M
WHERE M.CPF IN (SELECT C.CPF_MEDICO
FROM CRM C
WHERE C.CPF_MEDICO = M.CPF 
AND C.REGISTRO IN (SELECT P.REGISTRO
FROM CONTROLE_PRESCRICAO P
GROUP BY P.REGISTRO
HAVING COUNT(*) > 1
));

--Nome e cpf dos MEDICOs por nome do consultório que trabalham
SELECT M.NOME, M.CPF, C.NOME
FROM MEDICO M, ATENDIMENTO_MEDICO A, CONSULTORIO C
WHERE (M.CPF = A.CPF)
AND (A.CEP=C.CEP);

--Nome e cpf dos funcionário por nome do consultório que trabalham
SELECT F.NOME, F.CPF, C.NOME
FROM FUNCIONARIO F, SERVICO S, CONSULTORIO C
WHERE (F.CPF = S.CPF)
AND (S.CEP=C.CEP);
    
--CPF e nome de funcionários e Médicos por consultório (Inner Join)
SELECT M.NOME AS MEDICO, F.NOME AS FUNCIONÁRIO, CONCAT(CONCAT(C.ENDERECO, ', '), C.NOME) AS CONSULTÓRIO 
FROM CONSULTORIO C INNER JOIN ATENDIMENTO_MEDICO A ON (C.CEP = A.CEP) INNER JOIN MEDICO M ON (M.CPF = A.CPF), FUNCIONARIO F, SERVICO S
WHERE (S.CEP = A.CEP) AND (S.CPF = F.CPF);

--Nome dos médicos com mais de uma especialização 
SELECT M.NOME, M.ESPECIALIZACAO1, M.ESPECIALIZACAO2
FROM MEDICO M
WHERE M.ESPECIALIZACAO1 IS NOT NULL AND M.ESPECIALIZACAO2 IS NOT NULL;

--Médicos separados por suas especializações
SELECT M.NOME, M.ESPECIALIZACAO1, M.ESPECIALIZACAO2
FROM MEDICO M
ORDER BY ESPECIALIZACAO1, M.ESPECIALIZACAO2;

--Médicos que atendem a partir das 08:00 junto ao endereço do consultório
SELECT M.NOME, C.ENDERECO, C.CIDADE
FROM ATENDIMENTO_MEDICO A INNER JOIN MEDICO M ON (M.CPF=A.CPF) INNER JOIN CONSULTORIO C ON (C.CEP=A.CEP)
WHERE A.EXPEDIENTE LIKE '08:00%';

--Cidades que possuem de um a três pacientes registrados
SELECT P.END_CIDADE, COUNT(*) AS MORADORES
FROM PACIENTE P
WHERE P.END_CIDADE IS NOT NULL 
GROUP BY P.END_CIDADE
HAVING COUNT(*) BETWEEN 1 AND 3;

--Cidades que possuem de uma a três pessoas registradas(Operação com conjuntos)
SELECT END_CIDADE AS CIDADE, COUNT(*) AS NUMERO_DE_PESSOAS
FROM (
SELECT P.END_CIDADE,P.CPF 
FROM PACIENTE p
UNION ALL
SELECT M.END_CIDADE, M.CPF
FROM MEDICO M
UNION ALL
SELECT F.END_CIDADE, F.CPF
FROM FUNCIONARIO F
) 
WHERE END_CIDADE IS NOT NULL
GROUP BY END_CIDADE
HAVING COUNT(*) BETWEEN 1 AND 3;

--Cidades onde há ao menos dois pacientes com mais de 20 anos e em que a média de idade naquela cidade seja superior a 20 (Subselect com tabela)
SELECT P.END_CIDADE--, COUNT(*) AS NUMERO_DE_PACIENTES, AVG(IDADE) AS MEDIA_IDADE
FROM (SELECT P.END_CIDADE, P.IDADE
FROM PACIENTE P
WHERE P.IDADE > 20 AND P.END_CIDADE IS NOT NULL) P
GROUP BY END_CIDADE
HAVING COUNT(*) >= 2 AND AVG(P.IDADE) > 20;

-- A maior idade de cada cidade
SELECT P.END_CIDADE, MAX(P.IDADE) AS MAIS_VELHO
FROM PACIENTE P
WHERE P.END_CIDADE IS NOT NULL
GROUP BY P.END_CIDADE;

--O mais velho de cada cidade 
SELECT P.NOME, P.END_CIDADE, P.IDADE AS MAIS_VELHO
FROM PACIENTE P
WHERE (P.END_CIDADE, P.IDADE) = ANY (SELECT P.END_CIDADE, MAX(IDADE)
FROM PACIENTE P
WHERE P.END_CIDADE IS NOT NULL
GROUP BY P.END_CIDADE
);

--CEP, endereço e número de salas de cada consultório
SELECT S.CEP, S.ENDERECO, COUNT(*) AS QTD_SALAS 
FROM SALA S
GROUP BY S.CEP, S.ENDERECO;

--Todos os consultórios onde algum médico atende.
SELECT C.ENDERECO
FROM CONSULTORIO C
WHERE EXISTS (SELECT *
FROM ATENDIMENTO_MEDICO);

--Todos os consultórios onde não há funcionários.
SELECT C.ENDERECO
FROM CONSULTORIO C
WHERE NOT EXISTS (SELECT *
FROM SERVICO);

--Média entre as idades de médicos da mesma cidade
SELECT M.END_CIDADE AS CIDADE, AVG(M.IDADE) AS IDADE_MÉDIA
FROM MEDICO M
WHERE M.END_CIDADE IS NOT NULL
GROUP BY M.END_CIDADE;

SELECT M.END_CIDADE, AVG(EXTRACT(YEAR FROM CURRENT_DATE) - EXTRACT(YEAR FROM M.NASCIMENTO)) AS MEDIA_IDADE
FROM MEDICO M
WHERE M.END_CIDADE IS NOT NULL
GROUP BY M.END_CIDADE;

--Pacientes sem convênio
SELECT *
FROM PACIENTE P
WHERE P.CONVENIO IS NULL;

--Todos os consultório onde MEDICOs realizaram pelo menos um atendimento, pelo menos um funcionário trabalha e pelo menos um paciente tem convênio aceito por um médico que trabalha lá.
--(Semijoin)
SELECT CONCAT(CONCAT(C.ENDERECO, ', '), C.NOME) AS CONSULTÓRIO 
FROM CONSULTORIO C
WHERE EXISTS (SELECT *
FROM CONSULTA CO
WHERE CO.CEP = C.CEP)
AND EXISTS (SELECT *
FROM SERVICO S
WHERE S.CEP = C.CEP)
AND EXISTS (SELECT *
FROM PACIENTE P
WHERE P.CONVENIO IN(SELECT AC.CNPJ
FROM ACEITA_CONVENIO AC
WHERE AC.CPF_MEDICO IN(SELECT A.CPF
FROM ATENDIMENTO_MEDICO A
WHERE A.CEP = C.CEP)));

--Todos os medicamentos que estão sendo prescritos
SELECT M.NOME
FROM MEDICAMENTO M
WHERE M.NMR IN (SELECT PR.REMEDIO
FROM CONTROLE_PRESCRICAO PR);

--Consultas com o preço acima da média e nome dos pacientes consultados (Escalar)
SELECT CO.MOMENTO_CONSULTA, CO.ENDERECO, CO.VALOR, P.NOME
FROM CONSULTA CO, PACIENTE P
WHERE (CO.CPF_PACIENTE = P.CPF)
AND CO.VALOR > (SELECT TRUNC(AVG(VALOR), 2) FROM CONSULTA);

--Consultas associadas a documentos que incluem instruções para extração dentária
SELECT DOC.MOMENTO_CONSULTA, DOC.ENDERECO, P.NOME, M.NOME
FROM DOCUMENTO DOC, PACIENTE P, MEDICO M
WHERE DOC.INSTRUCOES LIKE '%Extração%' 
AND (P.CPF=DOC.CPF_PACIENTE)
AND (M.CPF=DOC.CPF_MEDICO);

--Consultas com o valor original e com o valor após o desconto do convênio do paciente atendido
SELECT P.NOME, C.NOME, CO.MOMENTO_CONSULTA, CV.NOME, CO.VALOR, CO.VALOR - (CO.VALOR * CAST(REPLACE(CV.DESCONTO, '%', '') AS FLOAT) / 100) AS VALOR_COM_DESCONTO
FROM CONSULTA CO INNER JOIN PACIENTE P ON (CO.CPF_PACIENTE=P.CPF) INNER JOIN CONSULTORIO C ON (C.CEP=CO.CEP) INNER JOIN CONVENIO CV ON(P.CONVENIO=CV.CNPJ)
WHERE CO.VALOR IS NOT NULL AND P.CONVENIO IS NOT NULL;

--Projetar todos os pacientes e suas respectivas consultas, preços e descontos pelo convênio, inclusive aqueles que não se consultaram ou não tem convênio ou que não tiveram consulta paga(Junção externa)
SELECT COALESCE(TO_CHAR(C.MOMENTO_CONSULTA), 'Nenhuma consulta registrada') AS CONSULTA, 
COALESCE(TO_CHAR(C.VALOR), 'Valor não estimado/consulta não obtida') AS VALOR, 
P.NOME AS NOME_PACIENTE, COALESCE(CV.DESCONTO, 'Sem desconto') AS DESCONTO_CONVÊNIO
FROM CONSULTA C FULL OUTER JOIN PACIENTE P ON (C.CPF_PACIENTE = P.CPF) FULL OUTER JOIN CONVENIO CV ON P.CONVENIO = CV.CNPJ;

--Médicos e os respectivos CEP dos consultórios que atendem
SELECT M.NOME AS MEDICO, C.NOME AS CONSULTÓRIO
FROM MEDICO M LEFT OUTER JOIN ATENDIMENTO_MEDICO A ON (A.CPF=M.CPF) LEFT OUTER JOIN CONSULTORIO C ON (A.CEP=C.CEP)

--Pacientes com exceção do mais velho
SELECT P.NOME
FROM PACIENTE P
WHERE P.IDADE < ANY (SELECT IDADE FROM PACIENTE);

--Pacientes que são mais novos que todos os outros de sua cidade
SELECT P1.NOME
FROM PACIENTE P1
WHERE P1.IDADE > ALL (SELECT IDADE FROM PACIENTE P2 WHERE P2.END_CIDADE = P1.END_CIDADE) AND
P1.END_CIDADE IS NOT NULL;

--Médicos que têm a mesma especialização e moram na mesma cidade que o MEDICO com CPF '44455566677'(Linha)
SELECT M.NOME
FROM MEDICO M
WHERE (M.ESPECIALIZACAO1, M.END_CIDADE) = (SELECT M2.ESPECIALIZACAO1, M2.END_CIDADE
FROM MEDICO M2
WHERE M2.CPF = '44455566677');

--Médicos que possuem menos consultas que o MEDICO com maior número de consultas
SELECT M.NOME
FROM MEDICO M
WHERE (SELECT COUNT(*) 
FROM CONSULTA C 
WHERE C.CPF_MEDICO = M.CPF) < (SELECT COUNT(*) 
FROM CONSULTA C2 
WHERE C2.CPF_MEDICO != M.CPF);

--Todas as cidades com pacientes registrados
SELECT DISTINCT P.END_CIDADE
FROM PACIENTE P;

--Pacientes e MEDICOs pelos quais já foram atendidos
SELECT P.NOME AS PACIENTE, M.NOME AS MEDICO
FROM CONSULTA C, PACIENTE P, MEDICO M
WHERE (C.CPF_PACIENTE = P.CPF) AND
(C.CPF_MEDICO = M.CPF);

--Pacientes e seus respectivos pacientes mais novos
SELECT P1.NOME, P2.NOME
FROM PACIENTE P1 INNER JOIN PACIENTE P2 ON (P1.IDADE > P2.IDADE);

--Pacientes sem consultas registradas
SELECT P.NOME AS PACIENTE
FROM CONSULTA C RIGHT OUTER JOIN PACIENTE P ON (P.CPF = C.CPF_PACIENTE)
WHERE C.CPF_PACIENTE IS NULL;
